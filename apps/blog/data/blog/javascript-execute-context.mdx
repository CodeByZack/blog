---
title: 'JS知识点之执行上下文和执行上下文栈'
publishedAt: '2021-01-30'
summary: '一个函数执行是需要一定条件来支持的，执行上下文就是这个提供条件给函数执行的地方，执行上下文栈则意味着，js里是以栈的形式来管理这些执行上下文的。'
---

### 执行上下文

函数执行是需要条件的，比如函数内定义的变量、函数参数是放在内存那个位置的？比如this的指向到底指向哪里的？再比如自由变量(即除了函数参数、本地变量外的其它变量)是在那个地方去取值？

以上几个问题，其实都是函数执行时背后的执行上下文解决的。

当你调用一个函数的时候，JS引擎会在内存里为你开辟一块内存，我们称之为执行上下文。

在真正运行你的函数代码之前，JS引擎会初始化好所有执行你函数所需要的条件，包括确定this指向，确定自由变量的寻址范围，确定本地变量，函数参数可以放在哪里。

准备好所以这些条件过后，JS引擎就会开始执行你的函数代码。

函数执行完毕，这块内存就会被释放掉，执行上下文也就被销毁了。

执行上下文的概念比较抽象，我通常想象它就是一个方框，一个函数调用就对应一个方框，放着函数执行所必备的东西，函数执行过程中如果需要就能从这里取。

### 活动的/挂起的执行上下文

函数调用就会JS就会生成一个执行上下文。

JS引擎当前正在处理的执行上下文，称之为活动的执行上下文。**JS里任意时刻有且只有一个活动的执行上下文**。

除了活动状态，执行上下文还有另一个状态，挂起状态。

因为函数调用是可以嵌套的，你可以在A函数里调用B函数，当调用A函数，生成一个执行上下文A，且处于活动状态。
代码运行到调用B函数处的时候，此时控制权转移到了B函数，执行上下文A不再是活动的，但也不能被销毁，因为A函数还没执行完，所以需要保留，这个状态就是挂起状态了，
此时正在执行B函数，调用B函数生成的执行上下文B，便成为了活动状态。当B函数执行完毕，执行上下文B被销毁。
控制权转回执行上下文A，它便又处于活动状态，代码继续往下执行。执行完毕，销毁回收。

### 执行上下文栈

上面提到函数可以嵌套调用，所以可能同时存在多个执行上下文，但一定记住有且只有一个处于活动状态。

执行上下文栈，就是为了管理多个执行上下文。通过名字可以得知，它是栈结构的，也就是先进后出(FILO)。这个特性很符合上述函数嵌套的过程。

还是函数A里调用函数B。

执行A，执行上下文A入栈，A活动状态
执行到B，执行上下文B入栈，B活动状态，A挂起状态
B执行完毕，执行上下文B出栈，销毁，A活动状态
A执行完毕，执行上下文A出栈，销毁

### 执行上下文结构


关于结构，网上经常有人讨论VO/AO。那是ES3时代的东西。结构看起来像下面这样。

<Image
  alt={`javascript-execute-context`}
  src={`/images/javascript-execute-context/es3-execute-context.png`}
  width={600}
  height={270}
/>

ES5的时候，已经更改成如下结构了。

<Image
  alt={`javascript-execute-context`}
  src={`/images/javascript-execute-context/es5-execute-context.png`}
  width={1135}
  height={581}
/>

虽然变动了，但核心还是保存那几个值，this，参数，本地变量，作用域链这些东西以供函数正常执行。